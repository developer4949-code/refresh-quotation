<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>IIIT-BH Student Management System</title>
  <link rel="icon" type="image/png" sizes="512x512" href="/iiit_logo_fevicon.png">
    <link rel="stylesheet" href="f_current.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<header class="mobile-header">
    <button id="menuToggle" aria-label="Toggle menu"><i class="fas fa-bars"></i></button>
    <h2>Classroom</h2>
</header>

<div class="container">
    <aside class="sidebar" id="sidebar">
        <a href="f_home.html" class="back-btn-sidebar">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
        </a>
        <nav class="nav-options">
  <a href="f_notice.html" class="side-btn"><i class="fas fa-bullhorn"></i> Notice Board</a>
<a href="f_student.html" class="side-btn"><i class="fas fa-user-graduate"></i> Student Details</a>
<a href="f_faculty.html" class="side-btn"><i class="fas fa-chalkboard-teacher"></i> Faculty Details</a>
<a href="f_timetable.html" class="side-btn"><i class="fas fa-calendar-alt"></i> Timetable</a>
<a href="f_grievance.html" class="side-btn"><i class="fas fa-comment-alt"></i> Grievance</a>
<a href="f_current.html" class="side-btn"><i class="fas fa-chalkboard-teacher"></i> Teaching Currently</a>

        
        </nav>
        <div class="logo-container">
            <img src="IIIT LOGO 3.svg" alt="IIIT Logo" class="logo"/>
            <p class="footer-text">IIIT Student Management System</p>
            <a href="https://www.iiit-bh.ac.in" class="footer-link" target="_blank" rel="noopener">www.iiit-bh.ac.in</a>
        </div>
    </aside>

    <main class="main-content">
        <div class="header-line">
            <h1><i class="fas fa-chalkboard-teacher"></i> Classroom Management</h1>
            <hr />
        </div>

        <!-- Course List Section -->
        <section class="section-container">
            <h2>Assigned Courses</h2>
            <div class="table-container">
                <table class="course-table">
                    <thead>
                        <tr>
                            <th>Course Code</th>
                            <th>Course Name</th>
                            <th>Semester</th>
                            <th>Branch/Section</th>
                            <th>Room No</th>
                        </tr>
                    </thead>
                    <tbody id="courseTableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- Attendance Section -->
        <section class="section-container">
            <h2>Take Attendance</h2>
            <div class="form-container">
                <form id="attendanceForm">
                    <div class="form-group">
                        <label for="courseSelect">Course</label>
                        <select id="courseSelect" required>
                            <option value="">Select Course</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="semesterSelect">Semester</label>
                        <select id="semesterSelect" required>
                            <option value="">Select Semester</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                        </select>
                    </div>
                    <div class="form-group">
                    <label for="batchSelect">Batch Year</label>
                        <select class="batch-select" required>
                       <option value="">Select Batch Year</option>
                         </select>
                     </div>

                    <div class="form-group">
                        <label for="branchSelect">Branch</label>
                        <select id="branchSelect" class="branch-select" required>
                            <option value="">Select Branch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="attendanceDate">Date</label>
                        <input type="date" id="attendanceDate" required>
                    </div>
                    <button type="submit" class="submit-btn">Start Attendance</button>
                </form>
            </div>

            <div id="attendanceTableContainer" style="display: none;">
                <h3>Mark Attendance</h3>
                <table class="course-table">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody"></tbody>
                </table>
                <button class="submit-btn" onclick="submitAttendance()">Submit Attendance</button>
            </div>

            <!-- Attendance Percentage Section -->
            <div class="form-container" style="margin-top: 20px;">
                <h3>Check Attendance Percentage</h3>
                <form id="attendanceCheckForm">
                    <div class="form-group">
                        <label for="checkCourseSelect">Course</label>
                        <select id="checkCourseSelect" required>
                            <option value="">Select Course</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="checkSemesterSelect">Semester</label>
                        <select id="checkSemesterSelect" required>
                            <option value="">Select Semester</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                        </select>
                    </div>
                    <div class="form-group">
    <label for="batchSelect">Batch Year</label>
    <select id="checkBatchSelect" class="batch-select" required>
        <option value="">Select Batch Year</option>
    </select>
</div>

                    <div class="form-group">
                        <label for="checkBranchSelect">Branch</label>
                        <select id="checkBranchSelect" class="branch-select" required>
                            <option value="">Select Branch</option>
                        </select>
                    </div>
                    <button type="submit" class="submit-btn">Check Attendance</button>
                </form>
                <div id="attendancePercentageContainer" style="display: none;">
                    <h3>Attendance Percentage</h3>
                    <table class="course-table">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody id="attendancePercentageTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Modified Attendance History Section -->
            <div class="form-container" style="margin-top: 20px;">
                <h3>Attendance History</h3>
                <form id="historyForm">
                    <div class="form-group">
                        <label for="historyCourseSelect">Course</label>
                        <select id="historyCourseSelect" required>
                            <option value="">Select Course</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="historySemesterSelect">Semester</label>
                        <select id="historySemesterSelect" required>
                            <option value="">Select Semester</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                        </select>
                    </div>
                    <div class="form-group">
    <label for="batchSelect">Batch Year</label>
    <select id="batchSelect" class="batch-select" required>
        <option value="">Select Batch Year</option>
    </select>
</div>

                    <div class="form-group">
                        <label for="historyBranchSelect">Branch</label>
                        <select id="historyBranchSelect" class="branch-select" required>
                            <option value="">Select Branch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="historyType">History Type</label>
                        <select id="historyType" required>
                            <option value="">Select Type</option>
                            <option value="studentId">By Student ID</option>
                            <option value="date">By Date</option>
                        </select>
                    </div>
                   <div class="form-group" id="studentIdGroup" style="display: none;">
    <label for="studentIdInput">Student ID</label>
    <input type="text" id="studentIdInput" >
</div>

                    <div class="form-group" id="historyDateGroup" style="display: none;">
                        <label for="historyDate">Date</label>
                        <input type="date" id="historyDate">
                    </div>
                    <button type="submit" class="submit-btn">View History</button>
                </form>
                <div id="historyTableContainer" style="display: none;">
                    <h3>Attendance History</h3>
                    <table class="course-table">
                        <thead id="historyTableHead"></thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Modified Announcement Section -->
        <section class="section-container">
            <h2>Class Announcements</h2>
            <div class="form-container">
                <form id="announcementForm">
                    <div class="form-group">
                        <label for="announceCourseSelect">Course</label>
                        <select id="announceCourseSelect" required>
                            <option value="">Select Course</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="announceSemesterSelect">Semester</label>
                        <select id="announceSemesterSelect" required>
                            <option value="">Select Semester</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                        </select>
                    </div>
                    <div class="form-group">
    <label for="batchSelect">Batch Year</label>
    <select id="batchSelect" class="batch-select" required>
        <option value="">Select Batch Year</option>
    </select>
</div>

                    <div class="form-group">
                        <label for="announceBranchSelect">Branch</label>
                        <select id="announceBranchSelect" class="branch-select" required>
    <option value="">Select Branch</option>
</select>

                    </div>
                    <div id="announcementDetails" style="display: none;">
                        <div class="form-group">
                            <label for="announcementText">Announcement</label>
                            <textarea id="announcementText" rows="4" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="announcementFile">Upload Document</label>
                            <input type="file" id="announcementFile" accept=".pdf,.doc,.docx">
                        </div>
                        <button type="submit" class="submit-btn">Announce</button>
                    </div>
                </form>
            </div>
            <div id="announcementHistoryContainer" class="announcement-history" style="display: none;">
                <h3>Announcement History</h3>
                <div id="announcementList"></div>
            </div>
        </section>
    </main>
</div>

<script>


const startYear = 2018;
    const currentYear = new Date().getFullYear();
    const batchYears = [];

    for (let year = startYear; year <= currentYear; year++) {
        batchYears.push(year);
    }

    // Populate all batch-select dropdowns
    function populateBatchDropdowns() {
        const batchDropdowns = document.querySelectorAll(".batch-select");

        batchDropdowns.forEach(dropdown => {
            // Clear existing options (except the first one)
            while (dropdown.options.length > 1) {
                dropdown.remove(1);
            }

            batchYears.forEach(year => {
                const option = document.createElement("option");
                option.value = year;
                option.textContent = year;
                dropdown.appendChild(option);
            });
        });
    }

    // Run on page load
    window.addEventListener('DOMContentLoaded', () => {
    populateCourseSelects();
    populateBranchSelects();
    populateBatchDropdowns();
});







// Hardcoded data
let students = []; // This should be declared and populated somewhere globally

// Sidebar toggle
document.getElementById('menuToggle').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('show');
});

// Populate course table
async function populateCourseTable() {
    const tbody = document.getElementById('courseTableBody');
    tbody.innerHTML = '';

    const email = localStorage.getItem("email");
    if (!email) {
        alert("Email not found in local storage.");
        return;
    }

    try {
        const response = await fetch(`https://13.201.146.238/assigned_courses/by-email/${email}`);
        if (!response.ok) {
            throw new Error("Failed to fetch course data");
        }

        const courses = await response.json();

        courses.forEach(course => {
            for (const [branch, info] of Object.entries(course.branchSection)) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${course.courseId}</td>
                    <td>${course.courseName}</td>
                    <td>${course.semester}</td>
                    <td>${branch}</td>
                    <td>${info.roomNumber || "N/A"}</td>
                `;
                tbody.appendChild(row);
            }
        });
    } catch (error) {
        console.error("Error loading courses:", error);
        alert("Could not load courses. Check the console for details.");
    }
}


// Populate course select options
async function populateCourseSelects() {
    const selects = [
        document.getElementById('courseSelect'),
        document.getElementById('checkCourseSelect'),
        document.getElementById('announceCourseSelect'),
        document.getElementById('historyCourseSelect')
    ];
    
    const email = localStorage.getItem("email");
    if (!email) {
        alert("Email not found in local storage.");
        return;
    }

    try {
        const response = await fetch(`https://13.201.146.238/assigned_courses/by-email/${email}`);
        if (!response.ok) throw new Error("Failed to fetch courses");
        const courseData = await response.json();

        selects.forEach(select => {
            select.innerHTML = '<option value="">Select Course</option>';
            courseData.forEach(course => {
                select.innerHTML += `<option value="${course.courseId}">${course.courseName} (${course.courseId})</option>`;
            });
        });

    } catch (error) {
        console.error("Error populating course selects:", error);
        alert("Failed to load course list. See console for details.");
    }
}


async function populateBranchSelects() {
    const selects = document.querySelectorAll('.branch-select');
    const email = localStorage.getItem("email");
    if (!email) {
        alert("Email not found in local storage.");
        return;
    }

    try {
        const response = await fetch(`https://13.201.146.238/assigned_courses/by-email/${email}`);
        if (!response.ok) throw new Error("Failed to fetch courses");
        const courseData = await response.json();

        // Extract unique branch-section keys
        const branchSet = new Set();
        courseData.forEach(course => {
            Object.keys(course.branchSection).forEach(branch => {
                branchSet.add(branch); // e.g., "B-tech_CSE_A"
            });
        });

        selects.forEach(select => {
            select.innerHTML = '<option value="">Select Branch</option>';
            branchSet.forEach(branch => {
                select.innerHTML += `<option value="${branch}">${branch}</option>`;
            });
        });

    } catch (error) {
        console.error("Error populating branch selects:", error);
        alert("Failed to load branch list. See console for details.");
    }
}


// Function to toggle announcement details and history visibility
function toggleAnnouncementDetails() {
    const course = document.getElementById('announceCourseSelect').value;
    const semester = document.getElementById('announceSemesterSelect').value;
    const batch = document.querySelector('#announcementForm .batch-select').value; // ✅ Added batch
    const branch = document.getElementById('announceBranchSelect').value;
    const announcementDetails = document.getElementById('announcementDetails');
    const announcementHistoryContainer = document.getElementById('announcementHistoryContainer');

    if (course && semester && batch && branch) { // ✅ Include batch in the check
        announcementDetails.style.display = 'block';
        announcementHistoryContainer.style.display = 'block';
        renderAnnouncements(course, semester, batch, branch); // ✅ Pass batch to renderer
    } else {
        announcementDetails.style.display = 'none';
        announcementHistoryContainer.style.display = 'none';
    }
}

// Add event listeners for announcement dropdowns
document.getElementById('announceCourseSelect').addEventListener('change', toggleAnnouncementDetails);
document.getElementById('announceSemesterSelect').addEventListener('change', toggleAnnouncementDetails);
document.getElementById('announceBranchSelect').addEventListener('change', toggleAnnouncementDetails);
document.querySelector('#announcementForm .batch-select').addEventListener('change', toggleAnnouncementDetails); // ✅ Added for batch



// Attendance form submission
document.getElementById('attendanceForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const semester = document.getElementById('semesterSelect').value;
    const batchSelect = document.querySelector('#attendanceForm .batch-select');
    const batch = batchSelect ? batchSelect.value : '';
    const branch = document.getElementById('branchSelect').value;

    if (!semester || !batch || !branch) {
        alert('Please select semester, batch year, and branch.');
        return;
    }

    // Construct the query params
    const semesterParam = 'sem' + semester; // e.g. sem3
    const batchParam = batch;
    const sectionParam = branch;

    const url = `https://13.201.146.238/student-mapper/students-with-names?semester=${encodeURIComponent(semesterParam)}&batch=${encodeURIComponent(batchParam)}&section=${encodeURIComponent(sectionParam)}`;

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch students');

        const students = await response.json();

        // Populate the attendance table
        const tbody = document.getElementById('attendanceTableBody');
        tbody.innerHTML = '';

        students.forEach(student => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${student.studentId}</td>
                <td>${student.name}</td>
                <td>
                    <button onclick="markAttendance('${student.studentId}', 'Present')" class="attendance-btn present-btn">Present</button>
                    <button onclick="markAttendance('${student.studentId}', 'Absent')" class="attendance-btn absent-btn">Absent</button>
                </td>
            `;
            tbody.appendChild(row);
        });

        // Show the attendance table container
        document.getElementById('attendanceTableContainer').style.display = 'block';

    } catch (error) {
        console.error('Error fetching students:', error);
        alert('Failed to load students. Please try again.');
    }
});


// Mark attendance
function markAttendance(studentId, status) {
    const buttons = document.querySelectorAll(`#attendanceTableBody button`);
    buttons.forEach(btn => {
        if (btn.parentElement.parentElement.children[0].textContent === studentId) {
            btn.style.backgroundColor = status === 'Present' ? '#28a745' : '#dc3545';
            btn.style.color = 'white';
        }
    });
}

// Submit attendance
async function submitAttendance() {
    const course = document.getElementById('courseSelect').value; // e.g. "CSE301"
   const rawDate = document.getElementById('attendanceDate').value; // "YYYY-MM-DD"
if (!rawDate) {
    alert('Please select a date.');
    return;
}
// Convert to "DD-MM-YYYY"
const [yyyy, mm, dd] = rawDate.split('-');
const formattedDate = `${dd}-${mm}-${yyyy}`;

    if (!course || !formattedDate) {
        alert('Please select course and date.');
        return;
    }

    const rows = document.querySelectorAll('#attendanceTableBody tr');

    // Prepare the attendance data object
    const attendanceData = {};

    rows.forEach(row => {
        const studentId = row.children[0].textContent;
        // Check if present-btn has green background, meaning present = true, else false
        const isPresent = row.querySelector('.present-btn').style.backgroundColor === 'rgb(40, 167, 69)';
        attendanceData[studentId] = isPresent;
    });

    const url = `https://13.201.146.238/attendance/student-wise-record?courseId=${encodeURIComponent(course)}&date=${encodeURIComponent(formattedDate)}`;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(attendanceData)
        });

        if (!response.ok) throw new Error('Failed to submit attendance');

        alert('Attendance submitted successfully!');
        document.getElementById('attendanceTableContainer').style.display = 'none';
        document.getElementById('attendanceForm').reset();

    } catch (error) {
        console.error('Error submitting attendance:', error);
        alert('Error submitting attendance. Please try again.');
    }
}

// Check attendance percentage
document.getElementById('attendanceCheckForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const courseFull = document.getElementById('checkCourseSelect').value;
    const semester = document.getElementById('checkSemesterSelect').value;
    const branch = document.getElementById('checkBranchSelect').value;
    const batch = document.getElementById('checkBatchSelect').value;

    if (!courseFull || !semester || !branch || !batch) {
        alert("Please fill all fields.");
        return;
    }

    const courseId = courseFull.split(" - ")[0].trim();
    const semesterParam = `sem${semester}`;
    const sectionParam = `${branch}`;

    const url = `https://13.201.146.238/attendance/attendance-summary?courseId=${encodeURIComponent(courseId)}&semester=${encodeURIComponent(semesterParam)}&batch=${encodeURIComponent(batch)}&section=${encodeURIComponent(sectionParam)}`;

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("Failed to fetch attendance summary");

        const summaryData = await response.json();

        const tbody = document.getElementById('attendancePercentageTable');
        tbody.innerHTML = '';

        summaryData.forEach(({ studentId, studentName, attendancePercentage }) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${studentId}</td>
                <td>${studentName}</td>
                <td style="color: ${attendancePercentage < 75 ? 'red' : 'green'}">${attendancePercentage}%</td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('attendancePercentageContainer').style.display = 'block';

    } catch (error) {
        console.error("Error fetching attendance summary:", error);
        alert("Error retrieving attendance summary.");
    }
});


// Attendance history



document.getElementById('historyType').addEventListener('change', (e) => {
    const type = e.target.value;
    document.getElementById('studentIdGroup').style.display = type === 'studentId' ? 'block' : 'none';
    document.getElementById('historyDateGroup').style.display = type === 'date' ? 'block' : 'none';
});

document.getElementById('historyForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const course = document.getElementById('historyCourseSelect').value;
    const semester = document.getElementById('historySemesterSelect').value;
    const branch = document.getElementById('historyBranchSelect').value;
    const batch = document.getElementById('batchSelect').value;
    const type = document.getElementById('historyType').value;

    console.log({ course, semester, branch, batch, type });


    if (!course || !semester || !branch || !batch || !type) {
        alert("Please fill all required fields.");
        return;
    }

    if (type === 'studentId') {
        const studentId = document.getElementById('studentIdInput').value.trim();
        if (!studentId) {
            alert("Please enter a Student ID.");
            return;
        }

        // build URL for studentId endpoint
        const courseId = course.split(" - ")[0].trim();
        const url = `https://13.201.146.238/attendance/attendance/student?studentId=${encodeURIComponent(studentId)}&courseId=${encodeURIComponent(courseId)}`;

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error("Failed to fetch attendance by student ID");
            const data = await res.json();

            // render data in table
            renderHistoryByStudent(data, courseId);
        } catch (err) {
            console.error(err);
            alert("Error fetching attendance by student ID.");
        }

    } else if (type === 'date') {
        let rawDate = document.getElementById('historyDate').value;
       if (!rawDate) {
          alert("Please select a date.");
          return;
            }
// Convert YYYY-MM-DD to DD-MM-YYYY
const [yyyy, mm, dd] = rawDate.split("-");
const date = `${dd}-${mm}-${yyyy}`;

        
    
        const courseId = course.split(" - ")[0].trim();
        const semesterParam = `sem${semester}`;
        const sectionParam = `${branch}`;

        const url = `https://13.201.146.238/attendance/attendance/by-date?courseId=${encodeURIComponent(courseId)}&semester=${encodeURIComponent(semesterParam)}&batch=${encodeURIComponent(batch)}&section=${encodeURIComponent(sectionParam)}&date=${encodeURIComponent(date)}`;

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error("Failed to fetch attendance by date");
            const data = await res.json();

            // render data in table
            renderHistoryByDate(data);
        } catch (err) {
            console.error(err);
            alert("Error fetching attendance by date.");
        }
    }
});

// Render functions:

function renderHistoryByStudent(records, courseId) {
    const tableHead = document.getElementById('historyTableHead');
    const tableBody = document.getElementById('historyTableBody');

    tableHead.innerHTML = `
        <tr>
            <th>Course</th>
            <th>Date</th>
            <th>Status</th>
        </tr>
    `;
    tableBody.innerHTML = '';

    records.forEach(rec => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${courseId}</td>
            <td>${rec.date}</td>
            <td>${rec.present ? 'Present' : 'Absent'}</td>
        `;
        tableBody.appendChild(row);
    });

    document.getElementById('historyTableContainer').style.display = 'block';
}

function renderHistoryByDate(records) {
    const tableHead = document.getElementById('historyTableHead');
    const tableBody = document.getElementById('historyTableBody');

    tableHead.innerHTML = `
        <tr>
            <th>Student ID</th>
            <th>Student Name</th>
            <th>Status</th>
        </tr>
    `;
    tableBody.innerHTML = '';

    records.forEach(rec => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${rec.studentId}</td>
            <td>${rec.studentName}</td>
            <td>${rec.present ? 'Present' : 'Absent'}</td>
        `;
        tableBody.appendChild(row);
    });

    document.getElementById('historyTableContainer').style.display = 'block';
}

//Announcement form submission


document.getElementById('announcementForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    // Get values from form
    const course = document.getElementById('announceCourseSelect').value;
    const semester = document.getElementById('announceSemesterSelect').value;
    const branch = document.getElementById('announceBranchSelect').value;
    const batch = document.querySelector('#announcementForm .batch-select').value;  // Yeh null ya undefined to nahi aa raha?

    const text = document.getElementById('announcementText').value;
    const file = document.getElementById('announcementFile').files[0];
    const postedBy = localStorage.getItem("email") || "anonymous@college.edu";

    const semesterParam = 'sem' + semester;

    // Construct announcement object
    const announcement = {
        announcement_content: text,
        posted_by: postedBy
    };

    // Construct form data
    const formData = new FormData();
    formData.append('announcement', new Blob([JSON.stringify(announcement)], { type: 'application/json' }));

    if (file) {
        formData.append('file', file);
    }

    // This is the key change: REMOVE query params from URL — send them in FormData only
    formData.append('branchSection', branch);
    formData.append('batchYear', batch);
    formData.append('semester', semesterParam);
    formData.append('courseId', course);


    function logFormData(fd) {
        console.log("FormData Contents:");
        for (const pair of fd.entries()) {
            if(pair[1] instanceof File) {
                console.log(pair[0] + ": File -", pair[1].name, pair[1].type, pair[1].size + " bytes");
            } else {
                console.log(pair[0] + ": " + pair[1]);
            }
        }
    }

    logFormData(formData);
    try {
        const response = await fetch(`https://13.201.146.238/announcement/create`, {
            method: 'POST',
            body: formData
        });

        const result = await response.text();

        alert("Announcement posted successfully!");

        // Clear fields
        document.getElementById('announcementText').value = '';
        document.getElementById('announcementFile').value = '';
        document.getElementById('announcementDetails').style.display = 'none';

        renderAnnouncements(course, semester, batch, branch);

    } catch (error) {
        console.error('Error posting announcement:', error);
        alert("Error: " + error.message);
    }
});

// Render announcements with filtering
async function renderAnnouncements(course, semester, batch, branch) {
    const list = document.getElementById('announcementList');
    list.innerHTML = '';

    try {
        const response = await fetch(`https://13.201.146.238/announcement/get?semester=sem${semester}&courseId=${course}`);
        const data = await response.json();

        data.forEach(announcement => {
            const content = announcement.announcement_content || "<i>No message</i>";
            const postedBy = announcement.posted_by || "Unknown";
            const postedOn = announcement.posted_on || "Unknown date";
            const attachment = announcement.attachment;

            const div = document.createElement('div');
            div.className = 'announcement-item';
            div.innerHTML = `
                <p><strong>${postedOn}</strong> - ${course} (sem${semester}, ${branch})</p>
                <p>${content}</p>
                <p><em>Posted by: ${postedBy}</em></p>
                ${attachment ? `<p><a href="${attachment}" target="_blank" class="announcement-file">View Attachment</a></p>` : ''}
            `;
            list.appendChild(div);
        });

        if (data.length === 0) {
            list.innerHTML = `<p>No announcements found.</p>`;
        }

    } catch (error) {
        console.error("Error fetching announcements:", error);
        list.innerHTML = `<p>Error loading announcements.</p>`;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    populateCourseTable();
    populateCourseSelects();
});
</script>
</body>
</html>