
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Update - Modern UI</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="e_supdate.css">
</head>
<body>

<header class="mobile-header">
  <button id="menuToggle"><i class="fas fa-bars"></i></button>
  <h2>Student Update</h2>
</header>

<div class="container">
  <div class="scroll-container">
    <aside class="sidebar" id="sidebar">
      <a href="e_home.html" class="back-btn-sidebar">
        <i class="fas fa-arrow-left"></i>
        Back to Dashboard
      </a>
    <a href="e_notice.html" class="side-btn"><i class="fas fa-bullhorn"></i> Notice Board</a>
<a href="e_student.html" class="side-btn"><i class="fas fa-user-graduate"></i> Student Details</a>
<a href="e_fee.html" class="side-btn"><i class="fas fa-address-book"></i> Student FeeLedger</a>
<a href="e_supdate.html" class="side-btn"><i class="fas fa-upload"></i> Student Update</a>
<a href="e_faculty.html" class="side-btn"><i class="fas fa-chalkboard-teacher"></i> Faculty Details</a>
<a href="e_fupdate.html" class="side-btn"><i class="fas fa-user-edit"></i> Faculty Update</a>
<a href="e_ginput.html" class="side-btn"><i class="fas fa-clipboard-check"></i> Grade Input</a>
<a href="e_grade.html" class="side-btn"><i class="fas fa-graduation-cap"></i> Student Grade Details</a>
<a href="e_timetable.html" class="side-btn active"><i class="fas fa-calendar-alt"></i> Timetable</a>

      
      
      <div class="logo-container">
        <img src="IIIT LOGO 3.svg" alt="IIIT Logo" class="logo"/>
        <p class="footer-text">IIIT Student Management System</p>
        <a href="https://www.iiit-bh.ac.in" class="footer-link" target="_blank">www.iiit-bh.ac.in</a>
      </div>
    </aside>

    <main class="main-content" id="mainContent">
      <div class="header-line">
        <h1><i class="fas fa-upload"></i> Student Update</h1>
        <hr />
      </div>
      
      <div class="student-update-container">
        <div class="update-slab">
          <h2><i class="fas fa-user-plus"></i> Create New Student</h2>
          <form id="createStudentForm">
            <div class="form-group">
              <label for="createProgram">Select Program:</label>
              <select id="createProgram" required>
                <option value="">-- Program --</option>
                <option value="b-tech">BTech</option>
                <option value="m-tech">MTech</option>
                <option value="phd">PhD</option>
              </select>
            </div>
            <div class="form-group">
              <label for="createBranch">Select Branch:</label>
              <select id="createBranch" required>
                <option value="" disabled selected>Select Branch</option>
      <option value="CSE">CSE</option>
      <option value="CE">CE</option>
      <option value="IT">IT</option>
      <option value="EEE">EEE</option>
      <option value="ETC">ETC</option>
              </select>
            </div>
            <div class="form-group">
              <label for="createAdmissionYear">Admission Year:</label>
              <select id="createAdmissionYear" required>
                <option value="">-- Select Year --</option>
              </select>
            </div>
            <div class="form-group">
              <label for="createExcelFile">Upload Excel File:</label>
              <input type="file" id="createExcelFile" accept=".xlsx, .xls" required>
            </div>
            <button type="submit" class="submit-btn">Submit</button>
          </form>
        </div>

        <div class="update-slab">
          <h2><i class="fas fa-upload"></i> Upload Student Data</h2>
          <form id="uploadStudentDataForm">
            <div class="form-group">
              <label for="uploadProgram">Select Program:</label>
              <select id="uploadProgram" required>
                <option value="">-- Program --</option>
                <option value="b-tech">BTech</option>
                <option value="m-tech">MTech</option>
                <option value="phd">PhD</option>
              </select>
            </div>
            <div class="form-group">
              <label for="uploadBranch">Select Branch:</label>
              <select id="uploadBranch" required>
                <option value="" disabled selected>Select Branch</option>
      <option value="CSE">CSE</option>
      <option value="CE">CE</option>
      <option value="IT">IT</option>
      <option value="EEE">EEE</option>
      <option value="ETC">ETC</option>
              </select>
            </div>
            <div class="form-group">
              <label for="uploadAdmissionYear">Admission Year:</label>
              <select id="uploadAdmissionYear" required>
                <option value="">-- Select Year --</option>
              </select>
            </div>
            <div class="form-group">
              <label for="uploadExcelFile">Upload Excel File:</label>
              <input type="file" id="uploadExcelFile" accept=".xlsx, .xls" required>
            </div>
            <button type="submit" class="submit-btn">Submit</button>
          </form>
        </div>

        <div class="update-slab">
          <h2><i class="fas fa-images"></i> Upload Student Images</h2>
          <form id="uploadStudentImagesForm">
            <div class="form-group">
              <label for="imageProgram">Select Program:</label>
              <select id="imageProgram" required>
                <option value="">-- Program --</option>
                <option value="b-tech">BTech</option>
                <option value="m-tech">MTech</option>
                <option value="phd">PhD</option>
              </select>
            </div>
            <div class="form-group">
              <label for="imageBranch">Select Branch:</label>
              <select id="imageBranch" required>
                <option value="" disabled selected>Select Branch</option>
      <option value="CSE">CSE</option>
      <option value="CE">CE</option>
      <option value="IT">IT</option>
      <option value="EEE">EEE</option>
      <option value="ETC">ETC</option>
              </select>
            </div>
            <div class="form-group">
              <label for="imageAdmissionYear">Admission Year:</label>
              <select id="imageAdmissionYear" required>
                <option value="">-- Select Year --</option>
              </select>
            </div>
            <div class="form-group">
              <label for="imageFolder">Upload Image Folder (JPG format):</label>
              <input type="file" id="imageFolder" webkitdirectory directory multiple accept=".jpg, .jpeg" required>
            </div>
            <button type="submit" class="submit-btn">Submit</button>
          </form>
        </div>

        <div class="update-slab">
          <h2><i class="fab fa-google"></i> Add New Google Groups</h2>
          <form id="googleGroupsForm">
            <div class="form-group">
              <label for="groupsExcelFile">Upload Excel File:</label>
              <input type="file" id="groupsExcelFile" accept=".xlsx, .xls" required>
            </div>
            <button type="submit" class="submit-btn">Submit</button>
          </form>
        </div>

        <div class="update-slab">
  <h2><i class="fas fa-book"></i> Upload Student Course Excel</h2>
  <form id="uploadStudentCourseForm">
    <div class="form-group">
      <label for="courseProgram">Select Program:</label>
      <select id="courseProgram" required>
        <option value="">-- Program --</option>
        <option value="B-tech">BTech</option>
        <option value="M-tech">MTech</option>
        <option value="Phd">PhD</option>
      </select>
    </div>
    <div class="form-group">
      <label for="courseBranch">Select Branch:</label>
      <select id="courseBranch" required>
        <option value="" disabled selected>Select Branch</option>
        <option value="CSE_A">CSE_A</option>
      <option value="CSE_B">CSE_B</option>
        <option value="CE">CE</option>
        <option value="IT">IT</option>
        <option value="EEE">EEE</option>
        <option value="ETC">ETC</option>
      </select>
    </div>
    <div class="form-group">
      <label for="courseAdmissionYear">Admission Year:</label>
      <select id="courseAdmissionYear" required>
        <option value="">-- Select Year --</option>
      </select>
    </div>
    <div class="form-group">
      <label for="courseSemester">Select Semester:</label>
      <select id="courseSemester" required>
        <option value="">-- Semester --</option>
        <option value="sem1">Semester 1</option>
        <option value="sem2">Semester 2</option>
        <option value="sem3">Semester 3</option>
        <option value="sem4">Semester 4</option>
        <option value="sem5">Semester 5</option>
        <option value="sem6">Semester 6</option>
        <option value="sem7">Semester 7</option>
        <option value="sem8">Semester 8</option>
      </select>
    </div>
    <div class="form-group">
      <label for="courseExcelFile">Upload Course Excel File:</label>
      <input type="file" id="courseExcelFile" accept=".xlsx, .xls" required>
    </div>
    <button type="submit" class="submit-btn">Submit</button>
  </form>
</div>


<div class="update-slab">
  <h2><i class="fas fa-id-badge"></i> Upload Student ID Excel</h2>
  <form id="uploadStudentIdForm">
    <div class="form-group">
      <label for="idProgram">Select Program:</label>
      <select id="idProgram" required>
        <option value="">-- Program --</option>
        <option value="B-tech">BTech</option>
        <option value="M-tech">MTech</option>
        <option value="Phd">PhD</option>
      </select>
    </div>
    <div class="form-group">
      <label for="idBranch">Select Branch:</label>
      <select id="idBranch" required>
        <option value="" disabled selected>Select Branch</option>
        <option value="CSE_A">CSE_A</option>
      <option value="CSE_B">CSE_B</option>
        <option value="CE">CE</option>
        <option value="IT">IT</option>
        <option value="EEE">EEE</option>
        <option value="ETC">ETC</option>
      </select>
    </div>
    <div class="form-group">
      <label for="idAdmissionYear">Admission Year:</label>
      <select id="idAdmissionYear" required>
        <option value="">-- Select Year --</option>
      </select>
    </div>
    <div class="form-group">
      <label for="idSemester">Select Semester:</label>
      <select id="idSemester" required>
        <option value="">-- Semester --</option>
        <option value="1">Semester 1</option>
        <option value="2">Semester 2</option>
        <option value="3">Semester 3</option>
        <option value="4">Semester 4</option>
        <option value="5">Semester 5</option>
        <option value="6">Semester 6</option>
        <option value="7">Semester 7</option>
        <option value="8">Semester 8</option>
      </select>
    </div>
    <div class="form-group">
      <label for="idExcelFile">Upload Student ID Excel File:</label>
      <input type="file" id="idExcelFile" accept=".xlsx, .xls" required>
    </div>
    <button type="submit" class="submit-btn">Submit</button>
  </form>
</div>




      </div>
    </main>
  </div>
</div>

<script>
  const menuToggle = document.getElementById("menuToggle");
  const sidebar = document.getElementById("sidebar");
  const mainContent = document.getElementById("mainContent");

  // Populate Admission Year dropdowns
 const populateAdmissionYears = () => {
  const currentYear = new Date().getFullYear(); // Current year (e.g., 2025)
  const startYear = currentYear - 10; // Start from 10 years before
  const endYear = currentYear; // Up to the current year

  const admissionYearSelects = [
    document.getElementById("createAdmissionYear"),
    document.getElementById("uploadAdmissionYear"),
    document.getElementById("imageAdmissionYear"),
    document.getElementById("courseAdmissionYear"),
    document.getElementById("idAdmissionYear") 
  ];

  admissionYearSelects.forEach(select => {
    for (let year = startYear; year <= endYear; year++) {
      const option = document.createElement("option");
      option.value = year;
      option.textContent = year;
      select.appendChild(option);
    }
  });
};

  // Call the function to populate the dropdowns on page load
  populateAdmissionYears();

  // Sidebar toggle for mobile
  menuToggle.addEventListener("click", () => {
    sidebar.classList.toggle("show");
  });

  // Close sidebar when clicking outside on mobile
  document.addEventListener("click", (e) => {
    if (window.innerWidth <= 768) {
      if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
        sidebar.classList.remove("show");
      }
    }
  });

  // Synchronized scrolling between sidebar and main content
  let isSyncingSidebar = false;
  let isSyncingMain = false;

  sidebar.addEventListener("scroll", () => {
    if (!isSyncingSidebar) {
      isSyncingMain = true;
      const sidebarScrollRatio = sidebar.scrollTop / (sidebar.scrollHeight - sidebar.clientHeight);
      mainContent.scrollTop = sidebarScrollRatio * (mainContent.scrollHeight - mainContent.clientHeight);
    }
    isSyncingSidebar = false;
  });

  mainContent.addEventListener("scroll", () => {
    if (!isSyncingMain) {
      isSyncingSidebar = true;
      const mainScrollRatio = mainContent.scrollTop / (mainContent.scrollHeight - mainContent.clientHeight);
      sidebar.scrollTop = mainScrollRatio * (sidebar.scrollHeight - sidebar.clientHeight);
    }
    isSyncingMain = false;
  });

  // Form submission handlers
document.getElementById('createStudentForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const fileInput = document.getElementById('createExcelFile');
  const file = fileInput.files[0];

  if (!file) {
    alert('Please upload an Excel file.');
    return;
  }

  const reader = new FileReader();

  reader.onload = async function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });

    // Assume first sheet
    const firstSheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[firstSheetName];

    // Convert to JSON
   const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

    // Remove header row if it was interpreted as a data row
    const cleanData = jsonData.filter(entry => entry.email && entry.password);

    if (cleanData.length === 0) {
      alert('No valid email/password pairs found.');
      return;
    }

    try {
      const response = await fetch('https://13.201.146.238/api/auth/bulk-create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(cleanData)
      });

      if (response.ok) {
        alert('New student creation request submitted!');
      } else {
        const errorText = await response.text();
        alert('Submission failed: ' + errorText);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  };

  reader.readAsArrayBuffer(file);
});



document.getElementById('uploadStudentImagesForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const program = document.getElementById('imageProgram').value;
  const branch = document.getElementById('imageBranch').value;
  const admissionYear = document.getElementById('imageAdmissionYear').value;
  const filesInput = document.getElementById('imageFolder');
  const files = filesInput.files;

  if (!program || !branch || !admissionYear) {
    alert('Please select program, branch, and admission year.');
    return;
  }

  if (!files || files.length === 0) {
    alert('Please upload a folder with student images.');
    return;
  }

  // Construct URL with query parameters
  const baseUrl = 'https://13.201.146.238/api/github/upload-processed';
  const url = `${baseUrl}?department=${encodeURIComponent(branch)}&programme=${encodeURIComponent(program)}&batch=${encodeURIComponent(admissionYear)}`;

  // Prepare form data with all files (as 'files' field)
  const formData = new FormData();
  for (let i = 0; i < files.length; i++) {
    formData.append('files', files[i], files[i].name);
  }

  try {
    const response = await fetch(url, {
      method: 'POST',
      body: formData
    });

    if (response.ok) {
      alert('Student images uploaded successfully!');
    } else {
      const errorText = await response.text();
      alert('Upload failed: ' + errorText);
    }
  } catch (error) {
    alert('Network error: ' + error.message);
  }
});



document.getElementById('googleGroupsForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const fileInput = document.getElementById('groupsExcelFile');
  const file = fileInput.files[0];

  if (!file) {
    alert('Please upload an Excel file.');
    return;
  }

  const reader = new FileReader();
  reader.onload = async function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const firstSheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[firstSheetName];

    // Parse the sheet to JSON, assuming columns "groupName" and "groupMail"
    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

    // Validate and clean data
    const cleanData = jsonData
      .map(row => ({
        groupName: row.groupName || row['Group Name'] || row['groupname'] || '',
        groupMail: row.groupMail || row['Group Mail'] || row['groupmail'] || ''
      }))
      .filter(entry => entry.groupName && entry.groupMail);

    if (cleanData.length === 0) {
      alert('No valid groupName/groupMail pairs found in the Excel file.');
      return;
    }

    try {
      const response = await fetch('https://13.201.146.238/groups/bulk-upload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(cleanData)
      });

      if (response.ok) {
        alert('Google groups creation request submitted successfully!');
      } else {
        const errorText = await response.text();
        alert('Submission failed: ' + errorText);
      }
    } catch (error) {
      alert('Network error: ' + error.message);
    }
  };


 
  reader.readAsArrayBuffer(file);
});



document.getElementById('uploadStudentCourseForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const semester = document.getElementById('courseSemester').value;
  const batch = document.getElementById('courseAdmissionYear').value;
  const program = document.getElementById('courseProgram').value;
  const branch = document.getElementById('courseBranch').value;
  const section = `${program}_${branch}`; // NO _A here as you asked

  if (!semester || !batch || !program || !branch) {
    alert('Please fill all required fields.');
    return;
  }

  const fileInput = document.getElementById('courseExcelFile');
  const file = fileInput.files[0];
  if (!file) {
    alert('Please upload an Excel file.');
    return;
  }

  const reader = new FileReader();
  reader.onload = async function(event) {
    try {
      const data = new Uint8Array(event.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];

      // Parse Excel to JSON (each row an object)
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

      // Extract course IDs (assuming column name 'courseId' or similar)
      const courseIds = jsonData
        .map(row => row.courseId || row['Course ID'] || row['CourseId'])
        .filter(id => id && id.toString().trim() !== '');

      if (courseIds.length === 0) {
        alert('No course IDs found in the Excel file.');
        return;
      }

      // Build endpoint URL with query params
      const url = `https://13.201.146.238/student-mapper/store-courses?semester=${encodeURIComponent(semester)}&batch=${encodeURIComponent(batch)}&section=${encodeURIComponent(section)}`;

      // Send POST request
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(courseIds)
      });

      if (response.ok) {
        alert('Courses uploaded successfully!');
      } else {
        const errText = await response.text();
        alert('Upload failed: ' + errText);
      }
    } catch (err) {
      alert('Error processing the file: ' + err.message);
    }
  };

  reader.readAsArrayBuffer(file);
});


document.getElementById('uploadStudentDataForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const program = document.getElementById('uploadProgram').value;
    const branch = document.getElementById('uploadBranch').value;
    const enrollmentYear = document.getElementById('uploadAdmissionYear').value;
    const fileInput = document.getElementById('uploadExcelFile');
    const file = fileInput.files[0];

    if (!file || !program || !branch || !enrollmentYear) {
        alert("Please fill all fields and select a file.");
        return;
    }

    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet);

        const students = rows.map(row => ({
            id: row.id || row.ID || "",
            name: row.name || row.Name || "",
            email: row.email || row.Email || "",
            phone: row.phone || row.Phone || "",
            programme: program,
            branch: branch,
            enrollmentYear: enrollmentYear
        }));

        const response = await fetch("https://13.201.146.238/api/students/save_students", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(students)
        });

        if (!response.ok) {
            throw new Error("Server error: " + response.statusText);
        }

        alert("🎉 Students uploaded successfully!");
        fileInput.value = "";
    } catch (error) {
        console.error("Upload failed:", error);
        alert("❌ Upload failed. Check console for details.");
    }
});



 document.getElementById('uploadStudentIdForm').addEventListener('submit', async function (event) {
    event.preventDefault();

    const program = document.getElementById('idProgram').value;
    const branch = document.getElementById('idBranch').value;
    const admissionYear = document.getElementById('idAdmissionYear').value;
    const semester = document.getElementById('idSemester').value;
    const fileInput = document.getElementById('idExcelFile');

    if (!fileInput.files.length) {
      alert("Please select an Excel file.");
      return;
    }

    const section = `${program}_${branch}`; // e.g., B-tech_CSE
    const batch = admissionYear;
    const sem = `sem${semester}`;
    const file = fileInput.files[0];

    try {
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data, { type: "array" });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      // Flatten the first column (skip header if present)
      const studentIds = rows
        .flatMap(row => row[0])
        .filter(id => typeof id === 'string' && id.trim() !== '');

      if (studentIds.length === 0) {
        alert("No valid student IDs found in the Excel file.");
        return;
      }

      const url = `https://13.201.146.238/student-mapper/store-students?semester=${encodeURIComponent(sem)}&batch=${encodeURIComponent(batch)}&section=${encodeURIComponent(section)}`;

      const response = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(studentIds)
      });

      if (response.ok) {
        alert("Student IDs uploaded successfully!");
      } else {
        alert("Failed to upload student IDs.");
      }
    } catch (error) {
      console.error("Error reading file or sending request:", error);
      alert("Something went wrong while uploading.");
    }
  });

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


</body>
</html>
